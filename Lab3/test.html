<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>geo</title>
</head>
<body>
<script src="https://d3js.org/d3.v7.min.js"></script>
<svg id="my_dataviz" width="1300" height="800"></svg>
<script>

    // The svg
    const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    // Map and projection
    const path = d3.geoPath();
    const projection = d3.geoMercator()
        .scale(200)
        .center([0,20])
        .translate([width / 2, height / 2]);

    // Data and color scale
    var date_to_countries = new Map();
    var totalCase_per_country = new Map();
    var totalDeath_per_country = new Map();

    const colorScale = d3.scaleThreshold()
        .domain([100000, 1000000, 10000000, 30000000, 100000000, 500000000])
        .range(d3.schemeBlues[7]);
    //
    // Load external data and boot
    Promise.all([
        d3.json("/Lab3/custom.geo.json"),
        d3.csv("https://github.com/owid/covid-19-data/blob/master/public/data/owid-covid-data.csv", function(data) {
            date_to_countries = d3.group(data, d => d.date, d => d.iso_code)
            totalCase_per_country = d3.rollups(data, v => d3.sum(v, d => d.new_cases), d => d.iso_code)
            totalDeath_per_country = d3.rollups(data, v => d3.sum(v, d => d.new_deaths), d => d.iso_code)
        })])
        .then(function(loadData) {
            let topo = loadData[0]

            let mouseOver = function (d) {
                d3.selectAll(".Country[iso_code=AFG]")
                    .transition()
                    .duration(200)
                    .style("opacity", .5)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("opacity", 10)
                    .style("stroke", "black")
            }

            let mouseLeave = function (d) {
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    .style("opacity", .8)
                    .style("stroke", "transparent")
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("stroke", "transparent")
            }

            // Draw the map
            svg.append("g")
                .selectAll("path")
                .data(topo.features)
                .enter()
                .append("path")
                // draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )
                // set the color of each country
                .attr("fill", function (d) {
                    d.total = totalCase_per_country.get(d.properties.iso_a3) || 0;
                    return colorScale(d.total);
                })
                .style("stroke", "transparent")
                .attr("class", function (d) {
                    return "Country"
                })
                .attr("iso_code", function (d){
                    return d.properties.iso_a3;
                })
                .style("opacity", .8)
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave);


        })

</script>
</body>
</html>